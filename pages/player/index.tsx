import {
  Text,
  Flex,
  Image,
  Alert,
  Button,
  AlertIcon,
  Container,
  AlertTitle,
  AlertDescription,
} from "@chakra-ui/react";
import axios from "axios";
import Head from "next/head";
import { useEffect, useRef, useReducer } from "react";

import { useAuth } from "../../context/auth-context";

declare global {
  interface Window {
    Spotify: any;
    Vibrant: any;
    onSpotifyWebPlaybackSDKReady: any;
  }
}

enum ActionTypes {
  TOGGLE = "TOGGLE",
  TRACK_UPDATE = "TRACK_UPDATE",
}

type CurrentTrack = {
  uri: string | null;
  name: string | null;
  imageUrl: string | null;
};

interface State {
  playing?: boolean;
  activated?: boolean;
  currentTrack?: CurrentTrack;
}

interface Action {
  type: ActionTypes;
  payload: State;
}

const initialState: State = {
  playing: false,
  activated: false,
  currentTrack: {
    uri: null,
    name: null,
    imageUrl: null,
  },
};

const reducer = (state: State, action: Action) => {
  switch (action.type) {
    case ActionTypes.TOGGLE:
      return { ...state, ...action.payload };
    case ActionTypes.TRACK_UPDATE:
      return { ...state, ...action.payload };

    default:
      throw new Error(`Unhandled action type: ${action.type}`);
  }
};

export default function Player() {
  const playerRef = useRef<any>(null);
  const { accessToken, refreshToken, setAuthData } = useAuth();
  const [{ playing, activated, currentTrack }, dispatch] = useReducer(
    reducer,
    initialState
  );

  useEffect(() => {
    if (!accessToken) {
      window.location.href = "/";
    }
  });

  useEffect(() => {
    if (
      typeof window !== "undefined" &&
      accessToken?.length > 0 &&
      !activated
    ) {
      let done = false;

      window.onSpotifyWebPlaybackSDKReady = async () => {
        playerRef.current = new window.Spotify.Player({
          name: "zer0eXploitify",
          getOAuthToken: async (cb: (token: string) => void) => {
            if (!done) {
              cb(accessToken);
              done = true;
            } else {
              // try to get a new access token with the refresh token
              console.log("[Auth]: Refreshing access token...");
              if (refreshToken) {
                try {
                  const resp = await axios.post("/api/v1/auth/spotify", {
                    refreshToken,
                  });
                  setAuthData({
                    refreshToken,
                    accessToken: resp?.data?.accessToken,
                  });
                  cb(resp?.data?.accessToken);
                } catch (error) {
                  // will force user to login again
                  setAuthData({});
                }
              }
            }
          },
          volume: 0.5,
        });

        const player: any = playerRef.current;
        if (player) {
          // Ready
          player.addListener("ready", ({ device_id }: any) => {
            console.log("Ready with Device ID", device_id);
          });

          player.addListener("not_ready", ({ device_id }: any) => {
            console.log("Device ID has gone offline", device_id);
          });

          player.addListener("initialization_error", ({ message }: any) => {
            console.error(message);
          });

          player.addListener("authentication_error", ({ message }: any) => {
            // accessToken expired or there is none
            console.error(message);
          });

          player.addListener("account_error", ({ message }: any) => {
            console.error(message);
          });

          player.addListener("player_state_changed", (payload: any) => {
            const { track_window } = payload;
            const { current_track } = track_window;
            const images = track_window?.current_track?.album.images ?? [];
            const imageUrl = images[images.length - 1]?.url ?? "";

            if (currentTrack?.uri === current_track.uri) return;

            window.Vibrant.from(imageUrl).getPalette(
              (_err: any, palette: any) => {
                const { LightMuted, Vibrant } = palette;

                const from = Vibrant.rgb.reduce(
                  (color: string, cur: number) => color + cur.toFixed(2) + ", ",
                  ""
                );
                const to = LightMuted.rgb.reduce(
                  (color: string, cur: number) => color + cur.toFixed(2) + ", ",
                  ""
                );

                document.body.style.backgroundSize = "cover";
                document.body.style.backdropFilter = "blur(15px)";
                document.body.style.backgroundRepeat = "no-repeat";
                document.body.style.backgroundImage = `linear-gradient(to bottom, rgba(${from} 0.38), rgba(${to} 0.8)), url(${imageUrl})`;

                dispatch({
                  type: ActionTypes.TRACK_UPDATE,
                  payload: {
                    currentTrack: {
                      uri: current_track?.uri,
                      name: current_track?.name,
                      imageUrl,
                    },
                  },
                });
              }
            );
          });

          await player.connect();
        }
      };
    }
  }, [accessToken, currentTrack, activated, refreshToken, setAuthData]);

  return (
    <>
      <Head>
        <title>
          {currentTrack?.name
            ? `${currentTrack.name} | zer0eXploitify"}`
            : "Player | zer0eXploitify"}
        </title>
        <meta
          name="description"
          content="zer0eXploit's custom spotify player"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Container height="100vh">
        {currentTrack?.imageUrl && currentTrack?.name && (
          <Flex
            gap="1rem"
            height="100%"
            align="center"
            justify="center"
            direction="column"
          >
            <Image
              boxSize="300px"
              objectFit="cover"
              alt={currentTrack?.name}
              borderRadius="md"
              src={currentTrack?.imageUrl}
            />
            <Text fontSize="3xl" as="b" color="whitesmoke">
              {currentTrack.name}
            </Text>
            <Flex justify="center" align="center" gap="1rem">
              <Button
                onClick={async () => {
                  if (playerRef.current) {
                    await playerRef.current.previousTrack();
                  }
                }}
              >
                Prev
              </Button>
              <Button
                onClick={() => {
                  if (playerRef.current) {
                    if (!activated) {
                      playerRef.current.resume().then(() => {
                        dispatch({
                          type: ActionTypes.TOGGLE,
                          payload: { playing: true, activated: true },
                        });
                      });
                      playerRef.current.activateElement();
                    } else {
                      if (playing) {
                        playerRef.current.pause().then(() => {
                          dispatch({
                            type: ActionTypes.TOGGLE,
                            payload: { playing: false },
                          });
                        });
                      } else {
                        playerRef.current.resume().then(() => {
                          dispatch({
                            type: ActionTypes.TOGGLE,
                            payload: { playing: true },
                          });
                        });
                      }
                    }
                  }
                }}
              >
                {playing ? "Pause" : "Play"}
              </Button>
              <Button
                onClick={async () => {
                  if (playerRef.current) {
                    await playerRef.current.nextTrack();
                  }
                }}
              >
                Next
              </Button>
            </Flex>
          </Flex>
        )}
        {!currentTrack?.imageUrl && (
          <Flex justify="center" align="center" height="100%">
            <Alert
              status="loading"
              variant="left-accent"
              colorScheme="gray"
              flexDirection="column"
              alignItems="center"
              justifyContent="center"
              textAlign="center"
              height="200px"
            >
              <AlertIcon boxSize="40px" mr={0} />
              <AlertTitle mt={4} mb={1} fontSize="lg">
                Player not Selected
              </AlertTitle>
              <AlertDescription maxWidth="sm">
                Please select &apos;zer0eXploitify&apos; from devices on your
                Spotify application in order to listen on the web player.
              </AlertDescription>
            </Alert>
          </Flex>
        )}
      </Container>
    </>
  );
}
